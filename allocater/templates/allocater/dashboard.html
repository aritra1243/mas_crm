{% extends 'authentication/base.html' %}
{% block content %}
<div class="container-fluid">
  <div class="row">
    <!-- Sidebar -->
    <div class="col-md-2 sidebar">
      <h5 class="text-center mb-4"><i class="fas fa-tasks"></i> Allocater</h5>
      <a href="{% url 'allocater_dashboard' %}" class="active"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
      <a href="{% url 'allocater_notifications' %}">
        <i class="fas fa-bell"></i> Notifications
        {% if unread_count > 0 %}
          <span class="badge bg-danger">{{ unread_count }}</span>
        {% endif %}
      </a>
      <a href="{% url 'allocater_profile' %}"><i class="fas fa-user"></i> Profile</a>
      <a href="{% url 'logout' %}"><i class="fas fa-sign-out-alt"></i> Logout</a>
    </div>

    <!-- Main Content -->
    <div class="col-md-10 p-4">
      <h2 class="mb-4">Job Allocation Dashboard</h2>

      <!-- Statistics Cards -->
      <div class="row mb-4">
        <div class="col-md-2">
          <div class="card text-center bg-primary text-white">
            <div class="card-body">
              <h3>{{ stats.total_jobs }}</h3>
              <p class="mb-0">Total Jobs</p>
            </div>
          </div>
        </div>
        <div class="col-md-2">
          <a href="{% url 'allocater_assigned' %}" class="text-decoration-none">
            <div class="card text-center bg-success text-white">
              <div class="card-body">
                <h3>{{ stats.total_assigned }}</h3>
                <p class="mb-0">Assigned</p>
              </div>
            </div>
          </a>
        </div>
        <div class="col-md-2">
          <a href="{% url 'allocater_in_progress' %}" class="text-decoration-none">
            <div class="card text-center bg-info text-white">
              <div class="card-body">
                <h3>{{ stats.total_in_progress }}</h3>
                <p class="mb-0">In Progress</p>
              </div>
            </div>
          </a>
        </div>
        <div class="col-md-2">
          <div class="card text-center bg-warning text-white">
            <div class="card-body">
              <h3>{{ stats.total_hold }}</h3>
              <p class="mb-0">On Hold</p>
            </div>
          </div>
        </div>
        <div class="col-md-2">
          <div class="card text-center bg-danger text-white">
            <div class="card-body">
              <h3>{{ stats.total_cancel }}</h3>
              <p class="mb-0">Cancelled</p>
            </div>
          </div>
        </div>
        <div class="col-md-2">
          <a href="{% url 'allocater_completed' %}" class="text-decoration-none">
            <div class="card text-center bg-dark text-white">
              <div class="card-body">
                <h3>{{ stats.total_completed }}</h3>
                <p class="mb-0">Completed</p>
              </div>
            </div>
          </a>
        </div>
      </div>

      {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show mb-3" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}

      <!-- Jobs Table -->
      <div class="card">
        <div class="card-body">
          <table class="table table-hover align-middle">
            <thead>
              <tr>
                <th>Job ID</th>
                <th>Topic</th>
                <th>Word Count</th>
                <th>Expected Deadline</th>
                <th>Strict Deadline</th>
                <th>Writer Status</th>
                <th>Process Team Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for job in jobs %}
              <tr>
                <td>{{ job.job_id }}</td>
                <td>{{ job.topic|default:"Not specified"|truncatewords:8 }}</td>
                <td>{{ job.word_count }}</td>
                <td>{{ job.expected_deadline|date:"d M, h:i A" }}</td>
                <td>{{ job.strict_deadline|date:"d M, h:i A" }}</td>

                <!-- Writer Status -->
                <td>
                  {% if job.writer_status == 'open' %}
                    <span class="badge bg-primary">Open</span>
                  {% elif job.writer_status == 'in_progress' %}
                    <span class="badge bg-info">In Progress</span>
                  {% elif job.writer_status == 'closed' %}
                    <span class="badge bg-dark">Closed</span>
                  {% else %}
                    <span class="badge bg-secondary">Pending</span>
                  {% endif %}
                  <br>
                  <strong class="text-dark" style="font-size: 0.95em;">
                    {% if job.allocated_to %}
                      <i class="fas fa-user"></i> {{ job.allocated_to.first_name|default:job.allocated_to.username }}
                    {% else %}
                      <span class="text-muted">Not assigned</span>
                    {% endif %}
                  </strong>
                </td>

                <!-- Process Team Status -->
                <td>
                  {% if job.process_team_status == 'pending' %}
                    <span class="badge bg-warning">Pending</span>
                  {% elif job.process_team_status == 'in_progress' %}
                    <span class="badge bg-info">In Progress</span>
                  {% elif job.process_team_status == 'completed' %}
                    <span class="badge bg-success">Completed</span>
                  {% elif job.process_team_status == 'closed' %}
                    <span class="badge bg-dark">Closed</span>
                  {% else %}
                    <span class="badge bg-secondary">Not Assigned</span>
                  {% endif %}
                  <br>
                  <strong class="text-dark" style="font-size: 0.95em;">
                    {% if job.process_team_member %}
                      <i class="fas fa-user"></i> {{ job.process_team_member.first_name|default:job.process_team_member.username }}
                    {% else %}
                      <span class="text-muted">Not assigned</span>
                    {% endif %}
                  </strong>
                </td>

                <td>
                  <button
                    type="button"
                    class="btn btn-sm btn-primary manage-btn"
                    data-bs-toggle="modal"
                    data-bs-target="#allocateModal"
                    data-job-id="{{ job.id }}"
                    data-job-label="{{ job.job_id }}"
                  >
                    <i class="fas fa-user-plus"></i> Manage
                  </button>
                  <a href="{% url 'allocater_view_job' job.id %}" class="btn btn-sm btn-info">
                    <i class="fas fa-eye"></i> View
                  </a>
                  {% if job.attachment %}
                  <a href="{{ job.attachment.url }}" target="_blank" class="btn btn-sm btn-secondary">
                    <i class="fas fa-file"></i>
                  </a>
                  {% endif %}
                </td>
              </tr>
              {% empty %}
              <tr><td colspan="8" class="text-center">No jobs available for allocation</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Allocation Modal (single reusable) -->
<div class="modal fade" id="allocateModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          Manage Job: <span class="job-label"></span>
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <form method="POST" action="{% url 'allocater_dashboard' %}">
        {% csrf_token %}
        <div class="modal-body">
          <input type="hidden" name="job_id" value="">
          
          <div class="mb-3">
            <label class="form-label">Action</label>
            <select name="action" class="form-select" id="actionSelect">
              <option value="allocate_to_writer">Allocate to Writer</option>
              <option value="allocate_to_process_team">Allocate to Process Team</option>
              <option value="change_writer">Change Writer</option>
              <option value="change_process_team">Change Process Team</option>
              <option value="query">Query</option>
              <option value="cancel">Cancel</option>
              <option value="hold">Hold</option>
            </select>
          </div>

          <div class="mb-3" id="writerSelectDiv">
            <label class="form-label">Select Writer</label>
            <select name="writer_id" class="form-select">
              <option value="">Choose…</option>
              {% for writer in writers %}
                <option value="{{ writer.id }}">{{ writer.first_name|default:writer.username }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="mb-3" id="processTeamSelectDiv" style="display:none;">
            <label class="form-label">Select Process Team Member</label>
            <select name="process_team_id" class="form-select">
              <option value="">Choose…</option>
              {% for member in process_team_members %}
                <option value="{{ member.id }}">{{ member.first_name|default:member.username }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label">Note (optional)</label>
            <textarea name="status_note" class="form-control" rows="3"></textarea>
          </div>
        </div>

        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Submit</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  var modalEl = document.getElementById('allocateModal');
  var actionSelect = document.getElementById('actionSelect');
  var writerSelectDiv = document.getElementById('writerSelectDiv');
  var processTeamSelectDiv = document.getElementById('processTeamSelectDiv');

  // Fill fields when opening
  modalEl.addEventListener('show.bs.modal', function (event) {
    var button = event.relatedTarget;
    if (!button) return; // defensive
    modalEl.querySelector('input[name="job_id"]').value = button.getAttribute('data-job-id');
    modalEl.querySelector('.modal-title .job-label').textContent = button.getAttribute('data-job-label');
    actionSelect.value = 'allocate_to_writer';
    writerSelectDiv.style.display = 'block';
    processTeamSelectDiv.style.display = 'none';
  });

  // Fallback open for environments where data attributes are ignored
  document.querySelectorAll('.manage-btn').forEach(function(btn){
    btn.addEventListener('click', function(e){
      var m = window.bootstrap ? window.bootstrap.Modal.getOrCreateInstance(modalEl) : null;
      if (m) { m.show(); }
    });
  });

  // Toggle selectors by action
  actionSelect.addEventListener('change', function() {
    var action = this.value;
    if (action === 'allocate_to_writer' || action === 'change_writer') {
      writerSelectDiv.style.display = 'block';
      processTeamSelectDiv.style.display = 'none';
    } else if (action === 'allocate_to_process_team' || action === 'change_process_team') {
      writerSelectDiv.style.display = 'none';
      processTeamSelectDiv.style.display = 'block';
    } else {
      writerSelectDiv.style.display = 'none';
      processTeamSelectDiv.style.display = 'none';
    }
  });
});
</script>

<style>
  .sidebar { background-color: #2c3e50; min-height: 100vh; padding: 20px 0; }
  .sidebar a { color: #ecf0f1; text-decoration: none; padding: 15px 20px; display: block; transition: background-color 0.3s; position: relative; }
  .sidebar a:hover, .sidebar a.active { background-color: #34495e; }
  .sidebar a .badge { position: absolute; right: 20px; top: 50%; transform: translateY(-50%); font-size: 0.7rem; padding: 3px 7px; }
</style>
{% endblock %}
