{% extends 'authentication/base.html' %}

{% block content %}
<div class="container-fluid pt-3 pb-5 process-bg">
  <div class="row g-0">

    <!-- Sidebar -->
    <aside class="col-md-2 sidebar pe-0">
      <div class="sidebar-inner">
        <h5 class="text-center mb-4 text-white-50"><i class="fas fa-cogs me-2"></i>Process Team</h5>

        <a href="{% url 'process_team_dashboard' %}" class="active">
          <i class="fas fa-tachometer-alt me-2"></i>Dashboard
        </a>

        <a href="{% url 'process_team_notifications' %}">
          <i class="fas fa-bell me-2"></i>Notifications
          {% if unread_count %}
            <span class="badge rounded-pill bg-danger float-end">{{ unread_count }}</span>
          {% endif %}
        </a>

        <a href="{% url 'process_team_profile' %}">
          <i class="fas fa-user me-2"></i>Profile
        </a>

        <a href="{% url 'logout' %}">
          <i class="fas fa-sign-out-alt me-2"></i>Logout
        </a>
      </div>
    </aside>

    <!-- Main -->
    <main class="col-md-10 p-4">
      <div class="d-flex align-items-center justify-content-between mb-3">
        <h2 class="page-title mb-0">Process Team Dashboard</h2>
      </div>

      <!-- Stats -->
      <div class="row g-3 mb-4">
        <div class="col-sm-6 col-lg-4">
          <div class="stat-card stat-blue">
            <div>
              <div class="stat-number">{{ in_process_count }}</div>
              <div class="stat-label">Jobs in Process</div>
            </div>
            <i class="fas fa-spinner fa-lg opacity-50"></i>
          </div>
        </div>
        <div class="col-sm-6 col-lg-4">
          <div class="stat-card stat-green">
            <div>
              <div class="stat-number">{{ completed_count }}</div>
              <div class="stat-label">Completed</div>
            </div>
            <i class="fas fa-check-circle fa-lg opacity-50"></i>
          </div>
        </div>
      </div>

      <!-- Jobs table -->
      <div class="card shadow-sm border-0 mb-4">
        <div class="card-header py-3 bg-white border-0">
          <h5 class="mb-0"><i class="fas fa-tasks me-2"></i>Jobs Awaiting Processing</h5>
        </div>
        <div class="card-body pt-0">
          <div class="table-responsive">
            <table class="table align-middle table-hover mb-0">
              <thead class="table-light">
                <tr>
                  <th>Job ID</th>
                  <th>Topic</th>
                  <th>Word Count</th>
                  <th>Referencing</th>
                  <th>Writing Style</th>
                  <th>Deadline</th>
                  <th>Original Files</th>
                  <th>Writer’s Files</th>
                  <th class="text-end">Action</th>
                </tr>
              </thead>
              <tbody>
              {% for job in jobs %}
                <tr>
                  <td><strong>{{ job.get_masked_job_id }}</strong></td>
                  <td class="text-truncate" style="max-width: 260px;">{{ job.topic|truncatewords:10 }}</td>
                  <td><span class="badge bg-info-subtle text-info border border-info">{{ job.word_count }}</span></td>
                  <td>{{ job.referencing_style|default:"-" }}</td>
                  <td>{{ job.writing_style|default:"-" }}</td>
                  <td>
                    <span class="badge bg-warning-subtle text-warning border border-warning">
                      {{ job.strict_deadline|date:"d M Y, h:i A" }}
                    </span>
                  </td>

                  <!-- Original (client) -->
                  <td class="text-nowrap">
                    {% if job.attachment %}
                      <a href="{{ job.attachment.url }}" target="_blank" class="btn btn-xs btn-outline-secondary">
                        <i class="fas fa-paperclip me-1"></i>Original
                      </a>
                    {% else %}
                      <span class="text-muted">None</span>
                    {% endif %}
                  </td>

                  <!-- Writer uploads -->
                  <td class="text-nowrap">
                    {% if job.final_copy %}
                      <a href="{{ job.final_copy.url }}" target="_blank" class="btn btn-xs btn-outline-success me-1">
                        <i class="fas fa-file-arrow-down me-1"></i>Final
                      </a>
                    {% endif %}
                    {% if job.structure_file %}
                      <a href="{{ job.structure_file.url }}" target="_blank" class="btn btn-xs btn-outline-info me-1">
                        <i class="fas fa-file-alt me-1"></i>Structure
                      </a>
                    {% endif %}
                    {% if job.software_files %}
                      <a href="{{ job.software_files.url }}" target="_blank" class="btn btn-xs btn-outline-dark">
                        <i class="fas fa-folder-open me-1"></i>Software
                      </a>
                    {% endif %}
                    {% if not job.final_copy and not job.structure_file and not job.software_files %}
                      <span class="text-muted">No files</span>
                    {% endif %}
                  </td>

                  <td class="text-end text-nowrap">
                    <a href="{% url 'process_team_job_upload' job.id %}" class="btn btn-sm btn-primary">
                      <i class="fas fa-upload me-1"></i>Process
                    </a>
                    <button type="button" class="btn btn-sm btn-outline-info"
                            data-bs-toggle="modal" data-bs-target="#viewModal{{ job.id }}">
                      <i class="fas fa-eye me-1"></i>View
                    </button>
                  </td>
                </tr>
              {% empty %}
                <tr><td colspan="9" class="text-center py-4 text-muted">No jobs in process queue</td></tr>
              {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Recently completed -->
      <div class="card shadow-sm border-0">
        <div class="card-header py-3 bg-white border-0">
          <h5 class="mb-0"><i class="fas fa-check-circle me-2"></i>Recently Completed</h5>
        </div>
        <div class="card-body pt-0">
          <div class="table-responsive">
            <table class="table align-middle table-striped mb-0">
              <thead>
                <tr>
                  <th>Job ID</th>
                  <th>Topic</th>
                  <th>Completed On</th>
                  <th>Final</th>
                </tr>
              </thead>
              <tbody>
              {% for job in jobs_completed %}
                <tr>
                  <td>{{ job.get_masked_job_id }}</td>
                  <td class="text-truncate" style="max-width: 360px;">{{ job.topic|truncatewords:12 }}</td>
                  <td>{{ job.updated_at|date:"d M Y, h:i A" }}</td>
                  <td>
                    {% if job.decoration_final_file %}
                      <a href="{{ job.decoration_final_file.url }}" target="_blank" class="btn btn-xs btn-success">Download</a>
                    {% else %}-{% endif %}
                  </td>
                </tr>
              {% empty %}
                <tr><td colspan="4" class="text-center py-4 text-muted">No completed jobs yet</td></tr>
              {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>

    </main>
  </div>
</div>

{# Modals after table to avoid blink #}
{% for job in jobs %}
<div class="modal fade" id="viewModal{{ job.id }}" tabindex="-1" aria-hidden="true"
     data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content border-0 shadow">
      <div class="modal-header">
        <h5 class="modal-title">Job Details: {{ job.get_masked_job_id }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <h6 class="mb-2"><strong>Instructions</strong></h6>
        <div class="p-3 bg-light rounded mb-3">{{ job.instruction|linebreaks }}</div>

        <h6 class="mb-2"><strong>Writer’s Summary</strong></h6>
        <div class="p-3 bg-light rounded">
          {% if job.final_copy_summary %}{{ job.final_copy_summary|linebreaks }}
          {% else %}<span class="text-muted">No summary provided by writer.</span>{% endif %}
        </div>
      </div>
      <div class="modal-footer">
        <a href="{% url 'process_team_job_upload' job.id %}" class="btn btn-primary">
          <i class="fas fa-upload me-1"></i>Process
        </a>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
{% endfor %}

<style>
  .process-bg { background: radial-gradient(1200px 600px at 10% -10%, #6a89ff26, transparent),
                           radial-gradient(900px 600px at 100% 0, #19cc8e1f, transparent); }
  .sidebar { background:#1f2d3a; min-height:100vh; }
  .sidebar-inner { padding: 20px 0; }
  .sidebar a { color:#e8eef5; text-decoration:none; padding:12px 18px; display:block; }
  .sidebar a.active, .sidebar a:hover { background:#2b3b4c; }
  .page-title { font-weight: 700; }
  .stat-card { display:flex; align-items:center; justify-content:space-between; padding:18px 20px;
               border-radius:14px; color:#fff; box-shadow:0 8px 18px rgba(0,0,0,.08); }
  .stat-blue { background: linear-gradient(135deg,#5b86e5,#36d1dc); }
  .stat-green { background: linear-gradient(135deg,#42e695,#3bb2b8); }
  .stat-number { font-size: 34px; line-height:1; }
  .stat-label { opacity:.9; margin-top:6px; letter-spacing:.3px; }
  .btn-xs { padding: .25rem .5rem; font-size: .75rem; }
</style>
{% endblock %}
