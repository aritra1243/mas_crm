{% extends 'authentication/base.html' %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-2 sidebar">
            <h5 class="text-center mb-4"><i class="fas fa-dollar-sign"></i> Finance</h5>
            <a href="{% url 'accounts_dashboard' %}" class="active"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
            <a href="{% url 'logout' %}"><i class="fas fa-sign-out-alt"></i> Logout</a>
        </div>
        
        <div class="col-md-10 p-4">
            <h2 class="mb-4">Finance Dashboard</h2>
            
            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="card bg-success text-white">
                        <div class="card-body text-center">
                            <h3>{{ total_jobs }}</h3>
                            <p>Completed Jobs</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-primary text-white">
                        <div class="card-body text-center">
                            <h3>${{ total_value|floatformat:2 }}</h3>
                            <p>Total Revenue</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-info text-white">
                        <div class="card-body text-center">
                            <h3>${{ avg_value|floatformat:2 }}</h3>
                            <p>Average Job Value</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <h5><i class="fas fa-check-circle"></i> Completed Jobs, Financial Records</h5>
                    <button class="btn btn-light btn-sm" onclick="exportToCSV()">
                        <i class="fas fa-download"></i> Export to CSV
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="financeTable">
                            <thead>
                                <tr>
                                    <th>Job ID</th>
                                    <th>Topic</th>
                                    <th>Word Count</th>
                                    <th>Created By</th>
                                    <th>Completed Date</th>
                                    <th>Value ($)</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for job in jobs %}
                                <tr>
                                    <td><strong>{{ job.job_id }}</strong></td>
                                    <td>{{ job.topic|default:"Not specified"|truncatewords:10 }}</td>
                                    <td><span class="badge bg-info">{{ job.word_count }}</span></td>
                                    <td>{{ job.created_by.first_name|default:job.created_by.username }}</td>
                                    <td>{{ job.updated_at|date:"d M Y, h:i A" }}</td>
                                    <td><strong>${{ job.value|floatformat:2 }}</strong></td>
                                    <td><span class="badge bg-success">{{ job.get_status_display }}</span></td>
                                    <td>
                                        <button class="btn btn-sm btn-info" data-bs-toggle="modal" data-bs-target="#detailModal{{ job.id }}">
                                            <i class="fas fa-eye"></i> Details
                                        </button>
                                    </td>
                                </tr>
                                
                                <!-- Job Details Modal -->
                                <div class="modal fade" id="detailModal{{ job.id }}">
                                    <div class="modal-dialog modal-lg">
                                        <div class="modal-content">
                                            <div class="modal-header bg-success text-white">
                                                <h5>Job Financial Details: {{ job.job_id }}</h5>
                                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                            </div>
                                            <div class="modal-body">
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <h6><strong>Job Information:</strong></h6>
                                                        <table class="table table-sm table-borderless">
                                                            <tr>
                                                                <th>Job ID:</th>
                                                                <td>{{ job.job_id }}</td>
                                                            </tr>
                                                            <tr>
                                                                <th>Topic:</th>
                                                                <td>{{ job.topic|default:"Not specified" }}</td>
                                                            </tr>
                                                            <tr>
                                                                <th>Word Count:</th>
                                                                <td>{{ job.word_count }}</td>
                                                            </tr>
                                                            <tr>
                                                                <th>Referencing:</th>
                                                                <td>{{ job.referencing_style|default:"-" }}</td>
                                                            </tr>
                                                            <tr>
                                                                <th>Writing Style:</th>
                                                                <td>{{ job.writing_style|default:"-" }}</td>
                                                            </tr>
                                                        </table>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <h6><strong>Financial and Timeline:</strong></h6>
                                                        <table class="table table-sm table-borderless">
                                                            <tr>
                                                                <th>Value:</th>
                                                                <td><strong class="text-success">${{ job.value|floatformat:2 }}</strong></td>
                                                            </tr>
                                                            <tr>
                                                                <th>Created By:</th>
                                                                <td>{{ job.created_by.first_name|default:job.created_by.username }} ({{ job.created_by.email }})</td>
                                                            </tr>
                                                            <tr>
                                                                <th>Assigned To:</th>
                                                                <td>{{ job.allocated_to.first_name|default:"Not assigned" }}</td>
                                                            </tr>
                                                            <tr>
                                                                <th>Created Date:</th>
                                                                <td>{{ job.created_at|date:"d M Y, h:i A" }}</td>
                                                            </tr>
                                                            <tr>
                                                                <th>Completed Date:</th>
                                                                <td>{{ job.updated_at|date:"d M Y, h:i A" }}</td>
                                                            </tr>
                                                        </table>
                                                    </div>
                                                </div>
                                                
                                                <hr>
                                                
                                                <h6><strong>Deliverables:</strong></h6>
                                                <div class="d-flex gap-2 flex-wrap">
                                                    {% if job.decoration_final_file %}
                                                    <a href="{{ job.decoration_final_file.url }}" target="_blank" class="btn btn-sm btn-success">
                                                        <i class="fas fa-file"></i> Final File
                                                    </a>
                                                    {% endif %}
                                                    {% if job.decoration_ai_report %}
                                                    <a href="{{ job.decoration_ai_report.url }}" target="_blank" class="btn btn-sm btn-info">
                                                        <i class="fas fa-file-pdf"></i> AI Report
                                                    </a>
                                                    {% endif %}
                                                    {% if job.decoration_plag_report %}
                                                    <a href="{{ job.decoration_plag_report.url }}" target="_blank" class="btn btn-sm btn-warning">
                                                        <i class="fas fa-file-pdf"></i> Plag Report
                                                    </a>
                                                    {% endif %}
                                                    {% if job.decoration_decorated_file %}
                                                    <a href="{{ job.decoration_decorated_file.url }}" target="_blank" class="btn btn-sm btn-primary">
                                                        <i class="fas fa-star"></i> Decorated File
                                                    </a>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% empty %}
                                <tr>
                                    <td colspan="8" class="text-center">No completed jobs to display</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot>
                                <tr class="table-success">
                                    <th colspan="5" class="text-end">TOTAL:</th>
                                    <th colspan="3"><strong>${{ total_value|floatformat:2 }}</strong></th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Monthly Summary -->
            <div class="card mt-4">
                <div class="card-header bg-info text-white">
                    <h5><i class="fas fa-chart-line"></i> Monthly Summary</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-3">
                            <h4>January 2025</h4>
                            <p class="text-muted">Coming Soon</p>
                        </div>
                        <div class="col-md-3">
                            <h4>February 2025</h4>
                            <p class="text-muted">Coming Soon</p>
                        </div>
                        <div class="col-md-3">
                            <h4>March 2025</h4>
                            <p class="text-muted">Coming Soon</p>
                        </div>
                        <div class="col-md-3">
                            <h4>April 2025</h4>
                            <p class="text-muted">Coming Soon</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function exportToCSV() {
    const table = document.getElementById('financeTable');
    let csv = [];
    
    // Headers
    const headers = [];
    table.querySelectorAll('thead th').forEach(th => {
        headers.push(th.textContent.trim());
    });
    csv.push(headers.join(','));
    
    // Rows
    table.querySelectorAll('tbody tr').forEach(tr => {
        const row = [];
        tr.querySelectorAll('td').forEach((td, index) => {
            if (index < 7) { // exclude Actions column
                row.push('"' + td.textContent.trim().replace(/"/g, '""') + '"');
            }
        });
        if (row.length) csv.push(row.join(','));
    });
    
    // Download
    const csvContent = csv.join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'finance_report_' + new Date().toISOString().split('T')[0] + '.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}
</script>
{% endblock %}
